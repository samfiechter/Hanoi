<html>
  <head>
    <title>Towers of Hanoi</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript">
    function hanoi(home){
	this.drawPage(home);
    }
hanoi.prototype = {
    canv:0,
    mesg:0,
    step:0,
    go:0,
    reset:0,
    board:0,
    code:0,
    board:[[1,2,3,4,5,6],[],[]],
    moves:[],
    drawPage:function(c){
	var t =this;
	
	t.canv = $('<canvas>').attr('style','width:50%;float:left;');
	t.mesg = $('<div>').attr('style','width:50%;height:300px;float:left;overflow:scroll;background:white;');
	c.append($('<div>').width('100%').append(t.canv).append(t.mesg)).attr("style","background:#fafafa;");	
	t.code = $('<textarea>').attr('type','textarea').attr('style','width:100%;height:300px;overflow:scroll;');
	var loader=$('<div>').change(function(){
	    t.code.value(loader.text)})
	    .load('./initial-code.txt');
	t.step = $('<button>').text('Step').click(function(){t.next();});
	t.go = $('<button>').text('Go').click(function(){t.go();});
	t.reset = $('<button>').text('Reset/Load Function').click(function(){t.resetBoard();});
	c.append($('<div>').append(t.code).append(t.step).append(t.go).append(t.step).append(t.reset));
//	t.resetBoard();
	t.drawBoard();
    },
    resetBoard:function(){
	var t = this;
	t.board = [[1,2,3,4,5,6],[],[]];
	t.moves=[];
	t.mesg.empty();
	t.drawBoard();
	try{
	    eval(t.code.val())
	    Hanoi(t.board,0,2);
	} catch (e){
	    alert(e.message);
	}
    },
    drawBoard:function(){
	var t =this;
	var ctx = t.canv[0].getContext('2d');
	var w = t.canv[0].width;
	var h = t.canv[0].height;
	ctx.clearRect ( 0 , 0 , w,h);
	var fw = w/60;
	var sw = w/(2*t.board.length);
	var discs = 0;
	var maxdisc =0;
	for (var i=0;i<t.board.length;i++){
	    discs += t.board[i].length;
	    for (var j=0;j<t.board[i].length;j++){
		if(t.board[i][j] > maxdisc){ 
		    maxdisc = t.board[i][j];
		}
	    }
	}
	var fh = h/20;
	var dh = (h*.9)/(4*discs);
	var discfill =ctx.createLinearGradient(0,0,w,0);
	discfill.addColorStop(0,"black");
	discfill.addColorStop(0.5,"red");
	discfill.addColorStop(1,"white");
	var postfill=ctx.createLinearGradient(0,0,0,h);
	postfill.addColorStop(0,"black");
	postfill.addColorStop(1,"white");
	for (var i=0;i<t.board.length;i++){
	    ctx.fillStyle = postfill;
	    var k = (2*(i+1)) -1;  // 1,3,5
	    ctx.fillRect((k*sw)-fw,fh,2*fw,h-(2*fh));
	    for (var j=0;j<t.board[i].length;j++){
		var ds = sw * (0.9*t.board[i][j]/maxdisc);
		var dp = (h-fh )-((t.board[i].length-j)*dh*2);
		ctx.fillStyle = discfill;
		ctx.fillRect( (k*sw)-ds,dp-(0.9*dh),2*ds,1.8*dh);
	    }	    
	}
    },
    move:function(ft){
	var t = this;
	var f = ft[0];
	var to = ft[1];
	var fromExists =  t.board[f].length > 0;
	var canMove =  (t.board[to].length > 0 && t.board[f][0] < t.board[to][0]) || t.board[to].length ==0;
	var text  = "MoveDisc(" + f + ", " + to + ");";
	if( fromExists && canMove){
	    t.mesg.append($('<div>').text(text + "--OK!"));
	    t.board[to].unshift(t.board[f].shift());
	    t.drawBoard();	
	} else {
	    text += "--ERROR: ";
	    if (fromExists){
		t.mesg.append($('<div>').text(text + "Can't Put Bigger Pegs on Smaller Pegs"));
	    } else {
		t.mesg.append($('<div>').text(text +"No Peg to Move"));
	    }
	}

    },
    next:function(){	
	if(this.moves.length >1){
	    this.move(this.moves.pop());
	}
    },
    go:function(){
	var t = this;
	if(t.moves.length >1){
	    t.move(t.moves.pop());
	    window.setTimeout(500,function(){t.go();});
	}
    },
    pushMove:function(f,t){
	this.moves.push([f,t]);
    }
}
var myClass;
$(document).ready(function(){ myClass = new hanoi($('body'));});
function MoveDisc(from,to){
    myClass.pushMove(from,to);
}
</script>
    </head><body>
    <h1>Towers of Hanoi</h1>
    <div>This page allows the vistor to write javascript code to move the towers of hanoi.  It will take care of the housekeeping (rules of the game) and allow the user to simply write the code to move the blocks.</div>
    </body>
</html>
